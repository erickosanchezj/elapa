<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Taquería "El Apá" — Órdenes por Mesa</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="js/styles.css">
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#f59e0b">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto max-w-7xl p-4 md:p-8">
    <header class="mb-8 text-center">
      <h1 class="text-4xl md:text-5xl font-bold text-yellow-600">Taquería "El Apá"</h1>
      <p class="text-gray-600 mt-2">Panel de Administración · Órdenes por Mesa</p>
    </header>

    <section class="bg-white p-6 rounded-xl shadow mb-8">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
            <h2 class="text-2xl font-bold text-gray-700">Crear Mesa</h2>
            <a href="precios.html" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 text-sm px-4 py-2 rounded-lg border bg-gray-50 hover:bg-gray-100">
                <span>⚙️</span>
                Administrar Precios y Menú
            </a>
        </div>
        <div class="flex flex-col sm:flex-row gap-3 mt-4">
            <input id="table-name" type="text" placeholder="Nombre/No. de mesa (ej. Mesa 1)"
                   class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
            <input id="table-note" type="text" placeholder="Nota (opcional)"
                   class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
            <button id="add-table" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg">Agregar</button>
        </div>
    </section>

    <section class="relative z-0">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-2xl font-bold text-gray-700">Mesas</h2>
        <div class="text-right">
          <div id="grand-total" class="text-xl font-extrabold">TOTAL (activas): $0.00</div>
          <div class="flex gap-2 justify-end mt-2">
            <button id="show-report" class="text-sm bg-blue-800 hover:bg-blue-900 text-white px-3 py-1.5 rounded-lg">Reporte del Día</button>
            <button id="close-all" class="text-sm bg-gray-800 hover:bg-black text-white px-3 py-1.5 rounded-lg">Cobrar & Cerrar todas</button>
          </div>
        </div>
      </div>
      <div id="tables-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <footer class="mt-8 text-center text-xs text-gray-500">
      <span>Versión: </span><span id="app-version" class="font-medium">cargando…</span><span id="net-status" class="ml-2"></span>
    </footer>
  </div>

  <div id="report-modal" class="modal hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[10001]"><div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col"><div class="p-5 border-b flex items-center justify-between"><h3 class="text-2xl font-bold text-gray-800">Reporte del Día</h3><button id="report-close" aria-label="Cerrar" class="text-3xl leading-none text-gray-500 hover:text-gray-800">&times;</button></div><div class="p-5 overflow-y-auto"><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-center"><div class="bg-green-50 p-4 rounded-lg"><div class="text-sm text-green-700">Ventas Totales del Día</div><div id="report-total" class="text-3xl font-extrabold text-green-800">$0.00</div></div><div class="bg-blue-50 p-4 rounded-lg"><div class="text-sm text-blue-700">Mesas Cobradas Hoy</div><div id="report-tables-count" class="text-3xl font-extrabold text-blue-800">0</div></div></div><h4 class="text-lg font-semibold mb-3">Desglose de Productos Vendidos</h4><div id="report-items-breakdown" class="space-y-2"><div class="text-gray-500 italic">No hay ventas registradas hoy.</div></div></div></div></div>

  <div id="drawer" class="fixed inset-y-0 right-0 w-full sm:w-[34rem] bg-white shadow-2xl translate-x-full transition-transform z-[9999]"><div class="h-[100svh] flex flex-col"><div class="p-5 border-b flex items-center justify-between"><div><h3 id="drawer-title" class="text-2xl font-bold text-gray-800">Mesa</h3><p id="drawer-note" class="text-sm text-gray-500"></p><div id="drawer-status" class="mt-1 text-xs"></div></div><button id="drawer-close" aria-label="Cerrar" class="text-3xl leading-none text-gray-500 hover:text-gray-800">&times;</button></div><div class="p-5 overflow-y-auto flex-1"><h4 class="text-lg font-semibold mb-3">Agregar productos</h4><div id="menu-list" class="space-y-3 mb-6"></div><h4 class="text-lg font-semibold mb-2">Detalle de la mesa</h4><div id="table-summary" class="bg-gray-50 border rounded-lg p-4"></div></div><div class="p-5 border-t bg-gray-50 pb-[env(safe-area-inset-bottom)]"><div class="flex items-center justify-between mb-3"><span class="font-bold">Total</span><span id="table-total" class="text-xl font-extrabold">$0.00</span></div><div id="drawer-actions" class="grid grid-cols-2 gap-3"></div></div></div></div>

  <div id="backdrop" class="fixed inset-0 bg-black/40 opacity-0 pointer-events-none transition-opacity z-[9998]"></div>
  <div id="toast-wrap" class="fixed left-1/2 -translate-x-1/2 bottom-4 space-y-2 z-[10000] pointer-events-none"></div>

  <script src="js/app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = window.TaqueriaApp;
        
        function render() {
            renderTables();
            updateTimers();
            const currentTable = App.AppState.tables.find(t => t.id === App.AppState.currentTableId);
            if (currentTable) openDrawer(currentTable, false);
        }

        function renderTables() {
            const g = App.$('#tables-grid'); g.innerHTML = '';
            if (App.AppState.tables.length === 0) { g.innerHTML = `<div class="text-gray-500 italic">No hay mesas.</div>`; return; }
            App.AppState.tables.forEach(t => {
                const total = App.computeTableTotal(t);
                const card = document.createElement('div'); card.className = 'card bg-white rounded-xl shadow p-5 cursor-pointer relative border-l-4'; card.dataset.tableId = t.id;
                card.innerHTML = `<div class="absolute top-3 right-3 flex gap-2">${t.charged ? `<span class="badge bg-gray-800 text-white">COBRADA</span>` : ''}</div><h3 class="text-xl font-bold">${t.name}</h3><p class="text-sm text-gray-500 min-h-[20px]">${t.note || ''}</p><div class="mt-2 flex items-end justify-between"><div><span class="text-gray-600">Total</span><div class="text-xl font-extrabold">${App.money(total)}</div></div><div class="text-xs text-gray-500">${ t.charged && t.openDurationMs ? App.formatDuration(t.openDurationMs) : !t.charged && t.createdAt ? `<div data-created-at="${t.createdAt}"></div>` : '' }</div></div>`;
                g.appendChild(card);
            });
            App.$('#grand-total').textContent = 'TOTAL (activas): ' + App.money(App.computeGrandTotalActive());
        }

        function renderMenuList(table) {
            const m = App.$('#menu-list'); m.innerHTML = ''; const d = table.charged ? 'opacity-50 pointer-events-none' : '';
            App.AppState.items.forEach(it => {
                const q = table.order[it.id] || 0; const p = (it.id === 'taco_pastor' && App.AppState.promoEnabled) ? '<span class="ml-2 badge bg-red-500 text-white">2x1</span>' : '';
                const r = document.createElement('div'); r.className = `flex items-center justify-between bg-white border rounded-lg p-3 ${d}`;
                r.innerHTML = `<div><div class="font-semibold flex items-center">${it.label} ${p}</div><div class="text-gray-600 text-sm">${App.money(App.AppState.prices[it.id] || 0)} c/u</div></div><div class="flex items-center gap-2"><button data-minus="${it.id}" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 font-bold">−</button><input data-qty="${it.id}" type="number" min="0" value="${q}" class="w-16 text-center border rounded-md p-1"><button data-plus="${it.id}" class="w-8 h-8 rounded-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold">+</button></div>`;
                m.appendChild(r);
            });
        }

        function renderTableSummary(table) {
            const b = App.$('#table-summary'); b.innerHTML = ''; if (Object.keys(table.order).length === 0) { b.innerHTML = '<div class="text-gray-500">Sin productos aún.</div>'; return; }
            const u = document.createElement('ul'); u.className = 'space-y-1';
            for (const [i, q] of Object.entries(table.order)) {
                const l = (App.AppState.items.find(item => item.id === i)?.label) || i; const { chargedQty, total } = App.computeLine(i, q);
                const li = document.createElement('li'); li.className = 'flex items-center justify-between'; li.innerHTML = `<span>${q} × ${l} ${i === 'taco_pastor' && App.AppState.promoEnabled ? `(Pagas ${chargedQty})` : ''}</span><span class="font-semibold">${App.money(total)}</span>`;
                u.appendChild(li);
            } b.appendChild(u);
        }

        function renderDrawerActions(table) {
            const w = App.$('#drawer-actions');
            w.innerHTML = table.charged ? `<button id="reopen-table" class="col-span-2 bg-amber-500 hover:bg-amber-600 text-white font-semibold py-3 rounded-lg">Reabrir Mesa</button><button id="delete-table" class="col-span-2 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-lg">Eliminar Permanentemente</button>`
                : `<button id="print-bill" class="col-span-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg">Imprimir Cuenta</button><button id="close-table" class="col-span-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg">Cobrar & Cerrar</button><button id="clear-table" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg text-sm">Limpiar</button><button id="delete-table" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg text-sm">Eliminar</button>`;
        }
        
        function renderDailyReport(){const t=App.computeDailyReport();App.$("#report-total").textContent=App.money(t.totalSales);App.$("#report-tables-count").textContent=t.tablesCount;const e=App.$("#report-items-breakdown");e.innerHTML="";const n=Object.entries(t.itemCounts).sort((t,n)=>n[1]-t[1]);if(0===n.length)return void(e.innerHTML='<div class="text-gray-500 italic">No hay ventas registradas hoy.</div>');n.forEach(([n,o])=>{const d=App.AppState.items.find(t=>t.id===n),r=d?d.label:n,l=t.itemRevenue[n]||0,c=document.createElement("div");c.className="flex justify-between items-center bg-gray-50 p-3 rounded-lg",c.innerHTML=` <span class="font-medium text-gray-800">${r}</span> <div class="text-right"> <span class="font-bold text-lg">${o}</span> <span class="ml-2 text-sm text-gray-600">${App.money(l)}</span> </div> `,e.appendChild(c)})}

        function addTable() { const n = (App.$('#table-name').value||'').trim(), o = (App.$('#table-note').value||'').trim(); if (!n) return alert('Escribe un nombre o número de mesa.'); App.AppState.tables.push({id:App.uid(),name:n,note:o,order:{},charged:!1,paidAt:null,createdAt:Date.now(),openDurationMs:null}); App.$('#table-name').value='';App.$('#table-note').value=''; App.persist();render();App.toast('Mesa creada','success'); }
        function closeTable(t) { const e = App.AppState.tables.find(e => e.id === t); if (!e || e.charged) return; const a = App.computeTableTotal(e); if (!confirm(`Cobrar ${e.name} por ${App.money(a)} y marcar como COBRADA?`)) return; e.charged=!0; e.paidAt=Date.now(); e.openDurationMs=e.paidAt - e.createdAt; App.persist();render();App.toast(`Mesa ${e.name} cobrada`,'success'); }
        function reopenTable(t) { const e = App.AppState.tables.find(e => e.id === t); if (!e || !e.charged) return; if (!confirm(`Reabrir ${e.name} para seguir editando?`)) return; e.charged=!1; e.paidAt=null; e.openDurationMs=null; App.persist();render();App.toast('Mesa reabierta','info'); }
        function deleteTable(t) { if (!App.AppState.tables.find(e => e.id === t)) return; if (!confirm(`Eliminar mesa? Esta acción no se puede deshacer.`)) return; App.AppState.tables = App.AppState.tables.filter(e => e.id !== t); App.persist();closeDrawer();render();App.toast('Mesa eliminada','info'); }
        function changeQty(t, e, a) { const n = App.AppState.tables.find(e => e.id === t); if (!n || n.charged) return; const o = n.order[e] || 0, r = Math.max(0, o + a); 0 === r ? delete n.order[e] : n.order[e] = r; App.persist();render(); }
        function setQty(t,e,a) { const n=App.AppState.tables.find(e=>e.id===t); if(!n||n.charged) return; 0===a?delete n.order[e]:n.order[e]=a; App.persist();render(); }
        function clearTable(t){const n=App.AppState.tables.find(n=>n.id===t);n&&!n.charged&&confirm(`Limpiar orden de ${n.name}?`)&&(n.order={},App.persist(),render(),App.toast("Mesa limpiada","info"))}
        function closeAllTables(){if(0===App.AppState.tables.length)return;const t=App.AppState.tables.filter(n=>!n.charged);if(!t.length)return alert("No hay mesas activas.");const n=t.reduce((n,e)=>n+App.computeTableTotal(e),0);confirm(`Cobrar & Cerrar TODAS las mesas activas por ${App.money(n)}?`)&&(t.forEach(t=>{t.charged=!0;t.paidAt=Date.now();t.openDurationMs=t.paidAt-t.createdAt}),App.persist(),render(),App.toast("Mesas activas cobradas","success"))}
        function printBill(t){const e=App.AppState.tables.find(e=>e.id===t);if(!e)return;let a="";Object.entries(e.order).forEach(([t,n])=>{const o=App.AppState.items.find(e=>e.id===t),d=App.computeLine(t,n);a+=`<tr><td>${n}x</td><td>${o?o.label:"Producto desconocido"}</td><td class="text-right">${App.money(d.total)}</td></tr>`});const n=App.computeTableTotal(e),o=`<div id="print-area"><center><h1>Taquería "El Apá"</h1><p>Gracias por su preferencia</p></center><hr><p><b>Mesa:</b> ${e.name}</p><p><b>Fecha:</b> ${new Date().toLocaleString()}</p><hr><table>${a}</table><hr><h2 class="text-right">TOTAL: ${App.money(n)}</h2></div>`,d=document.createElement("iframe");d.style.display="none";document.body.appendChild(d);d.contentDocument.write(o);const r=d.contentDocument.createElement("style");r.textContent="body{font-family:monospace;font-size:10pt} h1,h2,p{margin:0} table{width:100%;border-collapse:collapse} td,th{padding:4px 2px;text-align:left} .text-right{text-align:right} hr{border-top:1px dashed #000}";d.contentDocument.head.appendChild(r);d.contentWindow.print();document.body.removeChild(d)}
        
        function openDrawer(t,e=!0){if(!t)return;App.AppState.currentTableId=t.id;App.$("#drawer-title").textContent=t.name;App.$("#drawer-note").textContent=t.note||"";App.$("#drawer-status").innerHTML=t.charged?`<span class="badge bg-gray-800 text-white">COBRADA</span> <span class="text-gray-500">— ${new Date(t.paidAt||Date.now()).toLocaleString()}</span>`:'<span class="badge bg-emerald-100 text-emerald-700">ACTIVA</span>';App.$("#table-total").textContent=App.money(App.computeTableTotal(t));renderMenuList(t);renderTableSummary(t);renderDrawerActions(t);if(e){App.$("#drawer").classList.remove("translate-x-full");App.$("#backdrop").classList.remove("pointer-events-none","opacity-0");document.documentElement.classList.add("overflow-hidden")}}
        function closeDrawer(){App.AppState.currentTableId=null;App.$("#drawer").classList.add("translate-x-full");App.$("#backdrop").classList.add("pointer-events-none","opacity-0");document.documentElement.classList.remove("overflow-hidden")}
        function updateTimers(){const e=Date.now();App.$$("[data-table-id]").forEach(t=>{const a=t.dataset.tableId,n=App.AppState.tables.find(e=>e.id===a);if(n&&!n.charged&&n.createdAt){const o=t.querySelector("[data-created-at]");o&&(o.textContent=App.formatElapsedTime(e-n.createdAt));const d=(e-n.createdAt)/6e4;t.style.borderColor=d>30?"#ef4444":d>15?"#f59e0b":"#22c55e"}else t.style.borderColor="transparent"})}
        function openReportModal(){renderDailyReport(),App.$("#report-modal").classList.remove("hidden")}
        function closeReportModal(){App.$("#report-modal").classList.add("hidden")}

        function wireEvents() {
            App.$('#add-table').addEventListener('click', addTable);
            App.$('#close-all').addEventListener('click', closeAllTables);
            App.$('#show-report').addEventListener('click', openReportModal);
            App.$('#report-close').addEventListener('click', closeReportModal);
            App.$('#report-modal').addEventListener('click', e => { if (e.target.id === 'report-modal') closeReportModal(); });
            App.$('#tables-grid').addEventListener('click', e => { const t = e.target.closest('[data-table-id]')?.dataset.tableId; if (t) { const a = App.AppState.tables.find(e => e.id === t); openDrawer(a); } });
            App.$('#drawer-close').addEventListener('click', closeDrawer);
            App.$('#backdrop').addEventListener('click', closeDrawer);
            App.$('#drawer-actions').addEventListener('click', e => { const t = App.AppState.currentTableId; if (!t) return; const a = e.target.id, n = {'reopen-table': reopenTable, 'delete-table': deleteTable, 'clear-table': clearTable, 'close-table': closeTable, 'print-bill': printBill}; if (n[a]) n[a](t); });
            const menuList=App.$('#menu-list');
            menuList.addEventListener('click',e=>{const t=App.AppState.currentTableId;if(!t)return;const a=e.target.closest('[data-plus]')?.dataset.plus;if(a)changeQty(t,a,1);const n=e.target.closest('[data-minus]')?.dataset.minus;if(n)changeQty(t,n,-1)});
            menuList.addEventListener('input',e=>{const t=App.AppState.currentTableId;if(!t)return;const a=e.target.closest('[data-qty]')?.dataset.qty;if(a)setQty(t,a,Math.max(0,Number(e.target.value||0)))});
        }

        function init() {
            App.loadState();
            wireEvents();
            render();
            setInterval(updateTimers, 30000);
            App.handleSW();
        }
        init();
    });
  </script>
</body>
</html>