<!DOCTYPE html>
<!-- /index.html -->
<!-- Main admin page for table orders -->
<!-- Provides interface to manage tables and orders -->
<!-- RELEVANT FILES: js/app.js, js/styles.css -->
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Taquería "El Apá" — Órdenes por Mesa</title>
  <script>tailwind.config = { darkMode: 'class' }</script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script>
      if (localStorage.theme === 'dark') {
        document.documentElement.classList.add('dark');
      }
    </script>
    <link rel="stylesheet" href="js/styles.css">
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#f59e0b">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
</head>
  <body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100">
    <div class="container mx-auto max-w-7xl p-4 md:p-8">
      <header class="mb-8 flex flex-col sm:flex-row items-center justify-between text-center sm:text-left">
        <div>
          <h1 class="text-4xl md:text-5xl font-bold text-yellow-600">Taquería "El Apá"</h1>
          <p class="text-gray-600 dark:text-gray-400 mt-2">Panel de Administración · Órdenes por Mesa</p>
        </div>
        <button id="theme-toggle" class="mt-4 sm:mt-0 p-2 rounded-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600">
          <span id="theme-icon" class="material-icons">dark_mode</span>
        </button>
      </header>

    <section class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow mb-8">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
            <h2 class="text-2xl font-bold text-gray-700 dark:text-gray-100">Crear Mesa</h2>
            <a href="precios.html" class="w-full sm:w-auto inline-flex items-center justify-center gap-2 text-sm px-4 py-2 rounded-lg border bg-gray-50 hover:bg-gray-100 dark:border-gray-600 dark:bg-gray-700 dark:hover:bg-gray-600">
                <span>⚙️</span>
                Administrar Precios y Menú
            </a>
        </div>
        <div class="flex flex-col sm:flex-row gap-3 mt-4">
            <input id="table-name" type="text" placeholder="Nombre/No. de mesa (ej. Mesa 1)"
                   class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400">
            <input id="table-note" type="text" placeholder="Nota (opcional)"
                   class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400">
              <button id="add-table" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-6 py-3 rounded-lg inline-flex items-center dark:bg-yellow-600 dark:hover:bg-yellow-500">
                  <span class="material-icons mr-1" aria-hidden="true">add</span>
                  Agregar
              </button>
        </div>
    </section>

    <section class="relative z-0">
      <div class="sticky top-0 bg-gray-100 dark:bg-gray-900 z-10 pb-2">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold text-gray-700 dark:text-gray-100">Mesas</h2>
          <div class="text-right">
            <div id="grand-total" class="text-xl font-extrabold dark:text-gray-100">TOTAL (activas): $0.00</div>
            <div class="flex gap-2 justify-end mt-2">
                <button id="show-report" class="text-sm bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1.5 rounded-lg inline-flex items-center dark:bg-yellow-700 dark:hover:bg-yellow-600">
                  <span class="material-icons mr-1" aria-hidden="true">assessment</span>
                  Reporte del Día
                </button>
                <button id="close-all" class="text-sm bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1.5 rounded-lg inline-flex items-center dark:bg-yellow-700 dark:hover:bg-yellow-600">
                  <span class="material-icons mr-1" aria-hidden="true">point_of_sale</span>
                  Cobrar & Cerrar todas
                </button>
            </div>
          </div>
        </div>
      </div>
      <div id="tables-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <footer class="mt-8 text-center text-xs text-gray-500 dark:text-gray-400">
      <span>Versión: </span><span id="app-version" class="font-medium">cargando…</span><span id="net-status" class="ml-2"></span>
    </footer>
  </div>
  
  <div id="tip-modal" class="modal hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[10001]">
    <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm">
        <div class="p-5 border-b"><h3 id="tip-modal-title" class="text-2xl font-bold text-gray-800 dark:text-gray-100">Agregar Propina</h3></div>
        <div class="p-5 space-y-4">
            <div class="text-center">
                <div class="text-sm text-gray-500 dark:text-gray-400">Subtotal</div>
                <div id="tip-subtotal" class="text-3xl font-bold">$0.00</div>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <button data-tip-percent="0.10" class="tip-option-btn">10%</button>
                <button data-tip-percent="0.15" class="tip-option-btn">15%</button>
                <button data-tip-percent="0.20" class="tip-option-btn">20%</button>
            </div>
            <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400">$</span>
                <input id="tip-custom-amount" type="number" placeholder="Otro monto" class="w-full pl-7 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100 dark:placeholder-gray-400">
            </div>
             <button data-tip-percent="0" class="tip-option-btn w-full">Sin Propina</button>
            <hr/>
            <div class="flex justify-between items-center text-lg">
                <span>Propina:</span>
                <span id="tip-amount" class="font-semibold">$0.00</span>
            </div>
            <div class="flex justify-between items-center text-2xl font-bold">
                <span>TOTAL:</span>
                <span id="tip-grand-total">$0.00</span>
            </div>
        </div>
        <div class="p-4 bg-gray-50 dark:bg-gray-700 grid grid-cols-2 gap-3 rounded-b-xl">
            <button id="tip-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 rounded-lg dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-100">Cancelar</button>
            <button id="tip-confirm" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg dark:bg-green-600 dark:hover:bg-green-500">Cobrar</button>
        </div>
    </div>
  </div>

  <div id="report-modal" class="modal hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[10001]"><div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col"><div class="p-5 border-b flex items-center justify-between"><h3 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Reporte del Día</h3><button id="report-close" aria-label="Cerrar" class="text-3xl leading-none text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200">&times;</button></div><div class="p-5 overflow-y-auto"><div id="report-summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center"></div><h4 class="text-lg font-semibold mb-3">Desglose de Productos Vendidos</h4><div id="report-items-breakdown" class="space-y-2"></div></div></div></div>

  <div id="drawer" class="fixed inset-y-0 right-0 w-full sm:w-[34rem] bg-white dark:bg-gray-800 shadow-2xl translate-x-full transition-transform z-[9999]"><div class="h-[100svh] flex flex-col"><div class="p-5 border-b flex items-center justify-between"><div><h3 id="drawer-title" class="text-2xl font-bold text-gray-800 dark:text-gray-100">Mesa</h3><p id="drawer-note" class="text-sm text-gray-500 dark:text-gray-400"></p><div id="drawer-status" class="mt-1 text-xs"></div></div><button id="drawer-close" aria-label="Cerrar" class="text-3xl leading-none text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200">&times;</button></div><div class="p-5 overflow-y-auto flex-1"><h4 class="text-lg font-semibold mb-3">Agregar productos</h4><div id="quick-add" class="flex flex-wrap gap-2 mb-4"></div><div id="menu-list" class="space-y-3 mb-6"></div><h4 class="text-lg font-semibold mb-2">Detalle de la mesa</h4><div id="table-summary" class="bg-gray-50 dark:bg-gray-700 border dark:border-gray-600 rounded-lg p-4"></div></div><div class="p-5 border-t bg-gray-50 dark:bg-gray-700 dark:border-gray-600 pb-[env(safe-area-inset-bottom)]"><div class="flex items-center justify-between mb-3"><span class="font-bold">Total</span><span id="table-total" class="text-xl font-extrabold">$0.00</span></div><div id="drawer-actions" class="grid grid-cols-2 gap-3"></div></div></div></div>
  
  <div id="backdrop" class="fixed inset-0 bg-black/40 opacity-0 pointer-events-none transition-opacity z-[9998]"></div>
  <div id="toast-wrap" class="fixed left-1/2 -translate-x-1/2 bottom-4 space-y-2 z-[10000] pointer-events-none"></div>

  <script src="js/app.js"></script>
  <script src="js/theme.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = window.TaqueriaApp;
        let currentTipState = { tableId: null, subtotal: 0, tip: 0 };

        function render() {
            renderTables();
            updateTimers();
            const table = App.AppState.tables.find(t => t.id === App.AppState.currentTableId);
            if (table) {
                openDrawer(table, false);
            }
        }

        function renderTables() {
            const grid = App.$('#tables-grid');
            grid.innerHTML = '';
            if (App.AppState.tables.length === 0) {
                grid.innerHTML = `<div class="text-gray-500 dark:text-gray-400 italic">No hay mesas.</div>`;
                return;
            }
              App.AppState.tables.forEach(t => {
                  const subtotal = App.computeTableTotal(t);
                  const finalTotal = subtotal + (t.charged ? t.tip : 0);
                  const card = document.createElement('div');
                  card.className = 'card bg-white dark:bg-gray-800 rounded-xl shadow p-5 cursor-pointer relative border-l-4';
                  card.dataset.tableId = t.id;
                  const timeInfoHtml = t.charged && t.openDurationMs
                      ? App.formatDuration(t.openDurationMs)
                      : !t.charged && t.createdAt
                      ? `<div data-created-at="${t.createdAt}"></div>`
                      : '';
                  card.innerHTML = `
                      <div class=\"absolute top-3 right-3 flex gap-2\">${t.charged ? `<span class=\"badge bg-gray-800 text-white\">COBRADA</span>` : ''}</div>
                      <h3 class=\"text-xl font-bold\">${t.name}</h3>
                      <p class=\"text-sm text-gray-500 dark:text-gray-400 min-h-[20px]\">${t.note || ''}</p>
                      <div class=\"mt-2 flex items-end justify-between\">
                          <div>
                              <span class=\"text-gray-600 dark:text-gray-300\">Total</span>
                              <div class=\"text-xl font-extrabold\">${App.money(finalTotal)}</div>
                              ${t.charged && t.tip ? `<div class=\"text-sm text-amber-600 dark:text-amber-400\">Propina: ${App.money(t.tip)}</div>` : ''}
                          </div>
                          <div class=\"text-xs text-gray-500 dark:text-gray-400\">${timeInfoHtml}</div>
                      </div>`;
                  grid.appendChild(card);
              });
            App.$('#grand-total').textContent = 'TOTAL (activas): ' + App.money(App.computeGrandTotalActive());
        }

        function renderMenuList(table) {
            const menu = App.$('#menu-list');
            const quick = App.$('#quick-add');
            menu.innerHTML = '';
            quick.innerHTML = '';
            const isDisabled = table.charged ? 'opacity-50 pointer-events-none' : '';
            const popular = ['taco_pastor', 'taco_suadero'];
            popular.forEach(id => {
                const item = App.AppState.items.find(i => i.id === id);
                if (!item) return;
                [2,4,6].forEach(n => {
                    const btn = document.createElement('button');
                    btn.dataset.add = id;
                    btn.dataset.delta = n;
                    btn.className = 'bg-yellow-500 hover:bg-yellow-600 text-white text-sm px-3 py-2 rounded-lg';
                    btn.textContent = `${n} × ${item.label}`;
                    quick.appendChild(btn);
                });
            });
            App.AppState.items.forEach(it => {
                const qty = table.order[it.id] || 0;
                const promoBadge = (it.id === 'taco_pastor' && App.AppState.promoEnabled) ? '<span class="ml-2 badge bg-red-500 text-white">2x1</span>' : '';
                const row = document.createElement('div');
                row.className = `flex items-center justify-between bg-white dark:bg-gray-800 border rounded-lg dark:border-gray-600 p-3 ${isDisabled}`;
                row.innerHTML = `
                    <div>
                        <div class="font-semibold flex items-center">${it.label} ${promoBadge}</div>
                        <div class="text-gray-600 dark:text-gray-300 text-sm">${App.money(App.AppState.prices[it.id] || 0)} c/u</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button data-minus="${it.id}" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 font-bold dark:bg-gray-700 dark:hover:bg-gray-600">−</button>
                        <input data-qty="${it.id}" type="number" min="0" value="${qty}" class="w-16 text-center border rounded-md p-1 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-100">
                        <button data-plus="${it.id}" class="w-8 h-8 rounded-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold">+</button>
                        <div class="flex gap-1">
                            <button data-add="${it.id}" data-delta="2" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 font-bold dark:bg-gray-700 dark:hover:bg-gray-600">2</button>
                            <button data-add="${it.id}" data-delta="4" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 font-bold dark:bg-gray-700 dark:hover:bg-gray-600">4</button>
                            <button data-add="${it.id}" data-delta="6" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 font-bold dark:bg-gray-700 dark:hover:bg-gray-600">6</button>
                        </div>
                    </div>`;
                menu.appendChild(row);
            });
        }

        function renderTableSummary(table) {
            const box = App.$('#table-summary');
            box.innerHTML = '';
            if (Object.keys(table.order).length === 0) {
                box.innerHTML = '<div class="text-gray-500 dark:text-gray-400">Sin productos aún.</div>';
                return;
            }
              const ul = document.createElement('ul');
              ul.className = 'space-y-1';
              for (const [itemId, qty] of Object.entries(table.order)) {
                  const item = App.AppState.items.find(i => i.id === itemId);
                  const label = item ? item.label : itemId;
                  const { chargedQty, total } = App.computeLine(itemId, qty);
                  const li = document.createElement('li');
                  li.className = 'flex items-center justify-between';
                  li.innerHTML = `
                      <span>${qty} × ${label} ${itemId === 'taco_pastor' && App.AppState.promoEnabled ? `(Pagas ${chargedQty})` : ''}</span>
                      <span class="font-semibold">${App.money(total)}</span>`;
                  ul.appendChild(li);
              }
              box.appendChild(ul);
              if (table.charged && table.tip) {
                  const tipRow = document.createElement('div');
                  tipRow.className = 'mt-2 flex items-center justify-between text-sm text-amber-600 dark:text-amber-400';
                  tipRow.innerHTML = `<span>Propina</span><span class="font-semibold">${App.money(table.tip)}</span>`;
                  box.appendChild(tipRow);
              }
          }

        function renderDrawerActions(table) {
            const wrapper = App.$('#drawer-actions');
              if (table.charged) {
                  wrapper.innerHTML = `
                      <button id=\"print-bill\" class=\"col-span-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg dark:bg-blue-600 dark:hover:bg-blue-500\">Imprimir Cuenta</button>
                      <button id=\"reopen-table\" class=\"col-span-2 bg-amber-500 hover:bg-amber-600 text-white font-semibold py-3 rounded-lg dark:bg-amber-600 dark:hover:bg-amber-500\">Reabrir Mesa</button>
                      <button id=\"delete-table\" class=\"col-span-2 bg-red-500 hover:bg-red-600 text-white font-semibold py-3 rounded-lg dark:bg-red-600 dark:hover:bg-red-500\">Eliminar</button>`;
              } else {
                  wrapper.innerHTML = `
                      <button id="print-bill" class="col-span-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 rounded-lg dark:bg-blue-600 dark:hover:bg-blue-500">Imprimir Cuenta</button>
                      <button id="close-table" class="col-span-2 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg dark:bg-green-600 dark:hover:bg-green-500">Cobrar & Cerrar</button>
                      <button id="clear-table" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg text-sm dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-100">Limpiar</button>
                      <button id="delete-table" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg text-sm dark:bg-red-600 dark:hover:bg-red-500">Eliminar</button>`;
            }
        }
        
        function renderDailyReport() {
            const report = App.computeDailyReport();
            const summaryContainer = App.$("#report-summary");
            summaryContainer.innerHTML = `
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <div class="text-sm text-gray-700 dark:text-gray-300">Ventas (Subtotal)</div>
                    <div class="text-2xl font-extrabold text-gray-800 dark:text-gray-100">${App.money(report.totalSubtotals)}</div>
                </div>
                <div class="bg-amber-50 dark:bg-amber-700 p-4 rounded-lg">
                    <div class="text-sm text-amber-700 dark:text-amber-200">Propinas</div>
                    <div class="text-2xl font-extrabold text-amber-800 dark:text-amber-100">${App.money(report.totalTips)}</div>
                </div>
                <div class="bg-green-50 dark:bg-green-700 p-4 rounded-lg">
                    <div class="text-sm text-green-700 dark:text-green-200">Total Cobrado</div>
                    <div class="text-2xl font-extrabold text-green-800 dark:text-green-100">${App.money(report.totalSubtotals + report.totalTips)}</div>
                </div>`;

            const itemsContainer = App.$("#report-items-breakdown");
            itemsContainer.innerHTML = "";
            const sortedItems = Object.entries(report.itemCounts).sort((a, b) => b[1] - a[1]);

            if (sortedItems.length === 0) {
                itemsContainer.innerHTML = '<div class="text-gray-500 dark:text-gray-400 italic">No hay ventas registradas hoy.</div>';
                return;
            }

            sortedItems.forEach(([itemId, count]) => {
                const item = App.AppState.items.find(i => i.id === itemId);
                const label = item ? item.label : itemId;
                const revenue = report.itemRevenue[itemId] || 0;
                const el = document.createElement("div");
                el.className = "flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-3 rounded-lg";
                el.innerHTML = `
                    <span class=\"font-medium text-gray-800 dark:text-gray-100\">${label}</span>
                    <div class=\"text-right\">
                        <span class=\"font-bold text-lg\">${count}</span>
                        <span class=\"ml-2 text-sm text-gray-600 dark:text-gray-300\">${App.money(revenue)}</span>
                    </div>`;
                itemsContainer.appendChild(el);
            });
        }

        function addTable() {
            const name = App.$('#table-name').value.trim();
            const note = App.$('#table-note').value.trim();
            if (!name) return alert('Escribe un nombre o número de mesa.');
            App.AppState.tables.push({ id: App.uid(), name, note, order: {}, charged: false, paidAt: null, createdAt: Date.now(), openDurationMs: null, tip: 0 });
            App.$('#table-name').value = '';
            App.$('#table-note').value = '';
            App.persist();
            render();
            App.toast('Mesa creada', 'success');
        }

        function finalizeCloseTable(tableId, tipAmount) {
            const table = App.AppState.tables.find(t => t.id === tableId);
            if (!table) return;
            table.charged = true;
            table.paidAt = Date.now();
            table.openDurationMs = table.paidAt - table.createdAt;
            table.tip = tipAmount;
            App.persist();
            render();
            closeTipModal();
            App.toast(`Mesa ${table.name} cobrada`, 'success');
        }

        function reopenTable(tableId) {
            const table = App.AppState.tables.find(t => t.id === tableId);
            if (!table || !table.charged) return;
            if (!confirm(`Reabrir ${table.name}?`)) return;
            table.charged = false;
            table.paidAt = null;
            table.openDurationMs = null;
            table.tip = 0;
            App.persist();
            render();
            App.toast('Mesa reabierta', 'info');
        }

        function deleteTable(tableId) {
            if (!confirm(`Eliminar mesa? Esta acción no se puede deshacer.`)) return;
            App.AppState.tables = App.AppState.tables.filter(t => t.id !== tableId);
            App.persist();
            closeDrawer();
            render();
            App.toast('Mesa eliminada', 'info');
        }

        function changeQty(tableId, itemId, delta) {
            const table = App.AppState.tables.find(t => t.id === tableId);
            if (!table || table.charged) return;
            const currentQty = table.order[itemId] || 0;
            const nextQty = Math.max(0, currentQty + delta);
            if (nextQty === 0) {
                delete table.order[itemId];
            } else {
                table.order[itemId] = nextQty;
            }
            App.persist();
            render();
        }

        function setQty(tableId, itemId, qty) {
            const table = App.AppState.tables.find(t => t.id === tableId);
            if (!table || table.charged) return;
            if (qty === 0) {
                delete table.order[itemId];
            } else {
                table.order[itemId] = qty;
            }
            App.persist();
            render();
        }

        function clearTable(tableId) {
            const table = App.AppState.tables.find(t => t.id === tableId);
            if (table && !table.charged && confirm(`Limpiar orden de ${table.name}?`)) {
                table.order = {};
                App.persist();
                render();
                App.toast("Mesa limpiada", "info");
            }
        }

        function closeAllTables() {
            const activeTables = App.AppState.tables.filter(t => !t.charged);
            if (activeTables.length === 0) return alert("No hay mesas activas.");
            if (!confirm(`Cobrar & Cerrar TODAS las mesas activas (SIN propina)?`)) return;
            activeTables.forEach(t => {
                t.charged = true;
                t.paidAt = Date.now();
                t.openDurationMs = t.paidAt - t.createdAt;
                t.tip = 0;
            });
            App.persist();
            render();
            App.toast("Mesas activas cobradas", "success");
        }

        function printBill(tableId) {
            const table = App.AppState.tables.find(t => t.id === tableId);
            if (!table) return;
            let itemsHtml = "";
              Object.entries(table.order).forEach(([itemId, qty]) => {
                  const item = App.AppState.items.find(i => i.id === itemId);
                  const line = App.computeLine(itemId, qty);
                  itemsHtml += `<tr><td>${qty}x</td><td>${item ? item.label : "Item"}</td><td class="text-right">${App.money(line.total)}</td></tr>`;
              });
              const subtotal = App.computeTableTotal(table);
              const tipHtml = table.tip ? `<h2 class="text-right">PROPINA: ${App.money(table.tip)}</h2>` : '';
              const totalHtml = table.tip ? `<h2 class="text-right">TOTAL: ${App.money(subtotal + table.tip)}</h2>` : '';
              const ticketHtml = `<div id="print-area"><center><h1>Taquería \"El Apá\"</h1></center><hr><p><b>Mesa:</b> ${table.name}</p><p><b>Fecha:</b> ${new Date().toLocaleString()}</p><hr><table>${itemsHtml}</table><hr><h2 class=\"text-right\">SUBTOTAL: ${App.money(subtotal)}</h2>${tipHtml}${totalHtml}</div>`;
              const iframe = document.createElement("iframe");
              iframe.style.display = "none";
              document.body.appendChild(iframe);
              const doc = iframe.contentDocument;
            doc.write(ticketHtml);
            const style = doc.createElement("style");
            style.textContent = `body{font-family:monospace;font-size:10pt} h1,h2,p{margin:0} table{width:100%;border-collapse:collapse} td,th{padding:4px 2px;text-align:left} .text-right{text-align:right} hr{border-top:1px dashed #000}`;
            doc.head.appendChild(style);
            doc.close(); // Important for some browsers
            iframe.contentWindow.print();
            document.body.removeChild(iframe);
        }
        
        function openDrawer(table, shouldAnimate = true) {
            if (!table) return;
            App.AppState.currentTableId = table.id;
            App.$("#drawer-title").textContent = table.name;
              App.$("#drawer-note").textContent = table.note || "";
              App.$("#drawer-status").innerHTML = table.charged ? `<span class="badge bg-gray-800 text-white">COBRADA</span> <span class="text-gray-500 dark:text-gray-400">— ${new Date(table.paidAt || Date.now()).toLocaleString()}</span>` : '<span class="badge bg-emerald-100 text-emerald-700">ACTIVA</span>';
              App.$("#table-total").textContent = App.money(App.computeTableTotal(table) + (table.charged ? table.tip : 0));
              renderMenuList(table);
              renderTableSummary(table);
              renderDrawerActions(table);
            if (shouldAnimate) {
                App.$("#drawer").classList.remove("translate-x-full");
                App.$("#backdrop").classList.remove("pointer-events-none", "opacity-0");
                document.documentElement.classList.add("overflow-hidden");
            }
        }

        function closeDrawer() {
            App.AppState.currentTableId = null;
            App.$("#drawer").classList.add("translate-x-full");
            App.$("#backdrop").classList.add("pointer-events-none", "opacity-0");
            document.documentElement.classList.remove("overflow-hidden");
        }

        function updateTimers() {
            const now = Date.now();
            App.$$("[data-table-id]").forEach(card => {
                const tableId = card.dataset.tableId;
                const table = App.AppState.tables.find(t => t.id === tableId);
                if (table && !table.charged && table.createdAt) {
                    const timerEl = card.querySelector("[data-created-at]");
                    if (timerEl) timerEl.textContent = App.formatElapsedTime(now - table.createdAt);
                    const minutes = (now - table.createdAt) / 60000;
                    card.style.borderColor = minutes > 30 ? "#ef4444" : minutes > 15 ? "#f59e0b" : "#22c55e";
                } else {
                    card.style.borderColor = "transparent";
                }
            });
        }
        
        function openTipModal(tableId) {
            const table = App.AppState.tables.find(t => t.id === tableId);
            if (!table) return;
            const subtotal = App.computeTableTotal(table);
            currentTipState = { tableId, subtotal, tip: 0 };
            App.$('#tip-modal-title').textContent = `Agregar Propina a ${table.name}`;
            App.$('#tip-subtotal').textContent = App.money(subtotal);
            updateTipDisplay(0, null);
            App.$('#tip-modal').classList.remove('hidden');
        }

        function closeTipModal() {
            App.$('#tip-modal').classList.add('hidden');
        }

        function updateTipDisplay(tipAmount, selectedBtn) {
            currentTipState.tip = tipAmount;
            App.$('#tip-amount').textContent = App.money(tipAmount);
            App.$('#tip-grand-total').textContent = App.money(currentTipState.subtotal + tipAmount);
            App.$$('#tip-modal .tip-option-btn.selected').forEach(btn => btn.classList.remove('selected'));
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
            if (selectedBtn?.dataset.tipPercent) {
                App.$('#tip-custom-amount').value = '';
            }
        }

        function wireEvents() {
            App.$('#add-table').addEventListener('click', addTable);
            App.$('#close-all').addEventListener('click', closeAllTables);
            App.$('#show-report').addEventListener('click', () => { renderDailyReport(); App.$("#report-modal").classList.remove("hidden"); });
            App.$('#report-close').addEventListener('click', () => App.$("#report-modal").classList.add("hidden"));
            App.$('#tables-grid').addEventListener('click', e => { const t = e.target.closest('[data-table-id]')?.dataset.tableId; if (t) { const a = App.AppState.tables.find(e => e.id === t); openDrawer(a); } });
            App.$('#drawer-close').addEventListener('click', closeDrawer);
            App.$('#backdrop').addEventListener('click', closeDrawer);
            App.$('#drawer-actions').addEventListener('click', e => { const t = App.AppState.currentTableId; if (!t) return; const a = e.target.id, n = {'reopen-table': reopenTable, 'delete-table': deleteTable, 'clear-table': clearTable, 'close-table': () => openTipModal(t), 'print-bill': printBill}; if (n[a]) n[a](t); });
            const menuList = App.$('#menu-list');
            const quickAdd = App.$('#quick-add');
            const handleClick = e => {
                const t = App.AppState.currentTableId;
                if (!t) return;
                const addBtn = e.target.closest('[data-add]');
                if (addBtn) {
                    changeQty(t, addBtn.dataset.add, Number(addBtn.dataset.delta));
                    const item = App.AppState.items.find(i => i.id === addBtn.dataset.add);
                    App.toast(`${addBtn.dataset.delta} × ${item?.label || addBtn.dataset.add}`);
                    return;
                }
                const plus = e.target.closest('[data-plus]')?.dataset.plus;
                if (plus) changeQty(t, plus, 1);
                const minus = e.target.closest('[data-minus]')?.dataset.minus;
                if (minus) changeQty(t, minus, -1);
            };
            menuList.addEventListener('click', handleClick);
            quickAdd.addEventListener('click', handleClick);
            menuList.addEventListener('input', e => { const t = App.AppState.currentTableId; if (!t) return; const a = e.target.closest('[data-qty]')?.dataset.qty; if (a) setQty(t, a, Math.max(0, Number(e.target.value || 0))) });
            
            App.$('#tip-cancel').addEventListener('click', closeTipModal);
            App.$('#tip-confirm').addEventListener('click', () => finalizeCloseTable(currentTipState.tableId, currentTipState.tip));
            App.$$('#tip-modal [data-tip-percent]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const percent = Number(btn.dataset.tipPercent);
                    const tipAmount = currentTipState.subtotal * percent;
                    updateTipDisplay(tipAmount, btn);
                });
            });
            App.$('#tip-custom-amount').addEventListener('input', e => {
                const customAmount = Number(e.target.value || 0);
                updateTipDisplay(customAmount, null);
            });
        }

        function init() {
            App.loadState();
            wireEvents();
            render();
            setInterval(updateTimers, 30000);
            App.handleSW();

            // Checar si se accedió desde un "shortcut"
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'showReport') {
                openReportModal();
            }
        }
        init();
    });
  </script>
</body>
</html>