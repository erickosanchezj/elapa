<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Taquería "El Apa"</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#f59e0b">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .card { transition: transform .2s ease, box-shadow .2s ease; }
    .card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); }
    .badge { font-size:.7rem; padding:.2rem .5rem; border-radius:9999px; }
    /* optional: hide number steppers */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto max-w-7xl p-4 md:p-8">
    <header class="mb-8 text-center">
      <h1 class="text-4xl md:text-5xl font-bold text-yellow-600">Taquería "El Apa"</h1>
      <p class="text-gray-600 mt-2">Panel de Administración · Órdenes por Mesa</p>
    </header>

    <!-- Top controls -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <!-- Prices & promo -->
      <section class="bg-white p-6 rounded-xl shadow relative overflow-hidden">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Precios</h2>

        <!-- Promo switch -->
        <label class="flex items-center gap-3 mb-4 select-none cursor-pointer">
          <input id="promo-enabled" type="checkbox" class="w-5 h-5">
          <span class="font-medium">2×1 en <strong>Pastor</strong> disponible</span>
        </label>
        <p class="text-xs text-gray-500 -mt-2 mb-4">
          Si está activo, <em>Taco de Pastor</em> cobra <code>ceil(q/2)</code>. Úsalo para apagar la promo aun en lunes/miércoles.
        </p>

        <div id="price-editor" class="space-y-3"></div>

        <!-- Add item -->
        <div class="mt-5 border-t pt-5">
          <h3 class="font-semibold mb-2">Agregar producto</h3>
          <div class="flex flex-col gap-3">
            <input id="new-item-name" type="text" placeholder="Nombre del producto"
                   class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
            <div class="relative">
              <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</span>
              <input id="new-item-price" type="number" min="0" step="0.50" placeholder="Precio"
                     class="w-full pl-6 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
            </div>
            <button id="add-item" class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold px-6 py-3 rounded-lg">
              Agregar
            </button>
          </div>
          <p class="text-xs text-gray-500 mt-2">Los productos agregados no tienen promo; la promo es solo para “Taco de Pastor”.</p>
        </div>

        <!-- Save prices -->
        <button id="save-prices" class="mt-6 w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg">Guardar Cambios</button>
      </section>

      <!-- Create table -->
      <section class="bg-white p-6 rounded-xl shadow lg:col-span-2">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Crear Mesa</h2>
        <div class="flex flex-col sm:flex-row gap-3">
          <input id="table-name" type="text" placeholder="Nombre/No. de mesa (ej. Mesa 1)"
                 class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
          <input id="table-note" type="text" placeholder="Nota (opcional)"
                 class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
          <button id="add-table" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg">Agregar</button>
        </div>
        <p class="text-sm text-gray-500 mt-2">Crea una mesa y registra su orden desde el panel.</p>
      </section>
    </div>

    <!-- Tables grid -->
    <section class="relative z-0">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-2xl font-bold text-gray-700">Mesas</h2>
        <div class="text-right">
          <div id="grand-total" class="text-xl font-extrabold">TOTAL (activas): $0.00</div>
          <button id="close-all" class="mt-2 text-sm bg-gray-800 hover:bg-black text-white px-3 py-1.5 rounded-lg">Cobrar & Cerrar todas</button>
        </div>
      </div>
      <div id="tables-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>
  </div>

  <!-- Drawer (raised z) -->
  <div id="drawer" class="fixed inset-y-0 right-0 w-full sm:w-[34rem] bg-white shadow-2xl translate-x-full transition-transform z-50">
    <div class="h-[100svh] flex flex-col">
      <div class="p-5 border-b flex items-center justify-between">
        <div>
          <h3 id="drawer-title" class="text-2xl font-bold text-gray-800">Mesa</h3>
          <p id="drawer-note" class="text-sm text-gray-500"></p>
          <div id="drawer-status" class="mt-1 text-xs"></div>
        </div>
        <button id="drawer-close" aria-label="Cerrar" class="text-3xl leading-none text-gray-500 hover:text-gray-800">&times;</button>
      </div>
      <div class="p-5 overflow-y-auto flex-1">
        <h4 class="text-lg font-semibold mb-3">Agregar productos</h4>
        <div id="menu-list" class="space-y-3 mb-6"></div>

        <h4 class="text-lg font-semibold mb-2">Detalle de la mesa</h4>
        <div id="table-summary" class="bg-gray-50 border rounded-lg p-4"></div>
      </div>
      <div class="p-5 border-t bg-gray-50 pb-[env(safe-area-inset-bottom)]">
        <div class="flex items-center justify-between mb-3">
          <span class="font-bold">Total</span>
          <span id="table-total" class="text-xl font-extrabold">$0.00</span>
        </div>
        <div id="drawer-actions" class="flex gap-3">
          <!-- buttons injected dynamically per status -->
        </div>
      </div>
    </div>
  </div>

  <!-- Backdrop -->
  <div id="backdrop" class="fixed inset-0 bg-black/40 opacity-0 pointer-events-none transition-opacity z-40"></div>

  <script>
    // ---------------- Utilities ----------------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const money = n => '$' + (n || 0).toFixed(2);
    const uid = () => 'id_' + Math.random().toString(36).slice(2, 10);
    const isMonOrWed = () => { const d = new Date().getDay(); return d === 1 || d === 3; };

    // ---------------- Storage ----------------
    const BASE_ITEMS = [
      { id: 'taco_pastor', label: 'Taco de Pastor', base: true },
      { id: 'taco_suadero', label: 'Taco de Suadero', base: true },
      { id: 'taco_carbon', label: 'Taco al Carbón', base: true },
      { id: 'refresco', label: 'Refresco', base: true },
      { id: 'cerveza', label: 'Cerveza', base: true },
    ];
    const DEFAULT_PRICES = {
      refresco: 27.00,
      taco_pastor: 17.00,
      taco_suadero: 17.00,
      taco_carbon: 40.00,
      cerveza: 35.00
    };

    let items = JSON.parse(localStorage.getItem('tacos_items') || 'null') || BASE_ITEMS.slice();
    let prices = JSON.parse(localStorage.getItem('tacos_prices') || 'null') || { ...DEFAULT_PRICES };
    let promoEnabled = JSON.parse(localStorage.getItem('tacos_promo_enabled') || 'null');
    if (promoEnabled === null) promoEnabled = isMonOrWed();
    let tables = JSON.parse(localStorage.getItem('tacos_tables_v2') || '[]');

    function persist() {
      localStorage.setItem('tacos_items', JSON.stringify(items));
      localStorage.setItem('tacos_prices', JSON.stringify(prices));
      localStorage.setItem('tacos_promo_enabled', JSON.stringify(promoEnabled));
      localStorage.setItem('tacos_tables_v2', JSON.stringify(tables));
    }

    // ---------------- Totals ----------------
    function computeLine(itemId, qty) {
      const p = prices[itemId] || 0;
      let chargedQty = qty;
      if (itemId === 'taco_pastor' && promoEnabled) chargedQty = Math.ceil(qty / 2);
      return { unit: p, chargedQty, total: chargedQty * p };
    }
    function computeTableTotal(table) {
      let sum = 0;
      for (const [itemId, qty] of Object.entries(table.order)) sum += computeLine(itemId, qty).total;
      return sum;
    }
    function computeGrandTotalActive() {
      return tables.filter(t => !t.charged).reduce((a, t) => a + computeTableTotal(t), 0);
    }

    // ---------------- Price editor ----------------
    function renderPriceEditor() {
      const container = $('#price-editor');
      container.innerHTML = '';

      items.forEach(it => {
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between bg-gray-50 rounded-lg p-3 gap-3';
        row.innerHTML = `
          <div class="min-w-0 flex items-center gap-2">
            <span class="font-medium text-gray-700 truncate">${it.label}</span>
            ${it.id === 'taco_pastor'
              ? `<span class="inline-flex items-center justify-center h-5 px-2 rounded-full text-[10px] leading-none ${promoEnabled ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700'}">2×1</span>`
              : (it.base ? '' : '<span class="inline-flex items-center justify-center h-5 px-2 rounded-full text-[10px] leading-none bg-blue-100 text-blue-700">custom</span>')}
          </div>
          <div class="flex items-center gap-2 shrink-0">
            <div class="relative">
              <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-500 select-none">$</span>
              <input type="number" step="0.50" id="price_${it.id}" value="${(prices[it.id]||0).toFixed(2)}"
                     class="w-28 sm:w-24 pl-5 p-2 border rounded-md text-right focus:ring-2 focus:ring-yellow-500">
            </div>
            ${it.base ? '' : `<button data-del="${it.id}" class="text-red-600 hover:text-red-700 text-sm">Eliminar</button>`}
          </div>
        `;
        container.appendChild(row);
      });

      container.querySelectorAll('[data-del]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-del');
          if (!confirm('¿Eliminar este producto?')) return;
          items = items.filter(x => x.id !== id);
          delete prices[id];
          tables.forEach(t => { delete t.order[id]; });
          persist();
          renderPriceEditor();
          renderTables();
          if (currentTableId) openDrawer(currentTableId);
        });
      });
    }

    // ---------------- Items add ----------------
    function addNewItem() {
      const name = ($('#new-item-name').value || '').trim();
      const price = Number($('#new-item-price').value || 0);
      if (!name) return alert('Ponle nombre al producto.');
      if (!(price > 0)) return alert('Ponle un precio mayor a 0.');
      const id = 'custom_' + uid();
      items.push({ id, label: name, base: false });
      prices[id] = price;
      $('#new-item-name').value = '';
      $('#new-item-price').value = '';
      persist();
      renderPriceEditor();
      renderTables();
      if (currentTableId) openDrawer(currentTableId);
    }

    // ---------------- Tables grid ----------------
    function renderTables() {
      $('#promo-enabled').checked = !!promoEnabled;
      const grid = $('#tables-grid');
      grid.innerHTML = '';
      if (tables.length === 0) {
        grid.innerHTML = `<div class="text-gray-500 italic">No hay mesas.</div>`;
      } else {
        tables.forEach(t => {
          const total = computeTableTotal(t);
          const card = document.createElement('div');
          card.className = 'card bg-white rounded-xl shadow p-5 cursor-pointer relative';
          card.innerHTML = `
            <div class="absolute top-3 right-3 flex gap-2">
              <span class="badge ${promoEnabled ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700'}">2×1 Pastor ${promoEnabled ? 'ON' : 'OFF'}</span>
              ${t.charged ? `<span class="badge bg-gray-800 text-white">COBRADA</span>` : ''}
            </div>
            <h3 class="text-xl font-bold">${t.name}</h3>
            <p class="text-sm text-gray-500">${t.note ? t.note : '&nbsp;'}</p>
            <div class="mt-4 flex items-center justify-between">
              <span class="text-gray-600">Total</span>
              <span class="text-xl font-extrabold">${money(total)}</span>
            </div>
          `;
          card.addEventListener('click', () => openDrawer(t.id));
          grid.appendChild(card);
        });
      }
      $('#grand-total').textContent = 'TOTAL (activas): ' + money(computeGrandTotalActive());
    }

    // ---------------- Drawer ----------------
    let currentTableId = null;

    function openDrawer(tableId) {
      currentTableId = tableId;
      const t = tables.find(x => x.id === tableId);
      if (!t) return;

      $('#drawer-title').textContent = t.name;
      $('#drawer-note').textContent = t.note || '';
      $('#drawer-status').innerHTML = t.charged
        ? `<span class="badge bg-gray-800 text-white">COBRADA</span> <span class="text-gray-500">— ${new Date(t.paidAt||Date.now()).toLocaleString()}</span>`
        : `<span class="badge bg-emerald-100 text-emerald-700">ACTIVA</span>`;
      renderMenuList(t);
      renderTableSummary(t);
      $('#table-total').textContent = money(computeTableTotal(t));
      renderDrawerActions(t);

      const drawer = $('#drawer');
      const backdrop = $('#backdrop');
      drawer.classList.remove('translate-x-full');
      backdrop.classList.remove('pointer-events-none');
      backdrop.classList.add('opacity-100');
      document.documentElement.classList.add('overflow-hidden'); // lock page scroll
    }

    function closeDrawer() {
      const drawer = $('#drawer');
      const backdrop = $('#backdrop');
      drawer.classList.add('translate-x-full');
      backdrop.classList.add('pointer-events-none');
      backdrop.classList.remove('opacity-100');
      document.documentElement.classList.remove('overflow-hidden'); // unlock
      currentTableId = null;
    }

    function renderMenuList(table) {
      const menu = $('#menu-list');
      menu.innerHTML = '';

      items.forEach(it => {
        const qty = table.order[it.id] || 0;
        const disabled = table.charged ? 'opacity-50 pointer-events-none' : '';
        const isPastor = it.id === 'taco_pastor';
        const promoBadge = (isPastor && promoEnabled) ? '<span class="ml-2 text-xs bg-red-500 text-white px-2 py-0.5 rounded-full font-bold">2x1</span>' : '';
        const row = document.createElement('div');
        row.className = `flex items-center justify-between bg-white border rounded-lg p-3 ${disabled}`;
        row.innerHTML = `
          <div>
            <div class="font-semibold">${it.label} ${promoBadge}</div>
            <div class="text-gray-600 text-sm">${money(prices[it.id] || 0)} c/u</div>
          </div>
          <div class="flex items-center gap-2">
            <button data-minus="${it.id}" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 font-bold">−</button>
            <input data-qty="${it.id}" type="number" min="0" value="${qty}" class="w-16 text-center border rounded-md p-1">
            <button data-plus="${it.id}" class="w-8 h-8 rounded-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold">+</button>
          </div>
        `;
        menu.appendChild(row);
      });

      if (!table.charged) {
        menu.querySelectorAll('[data-plus]').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-plus');
            changeQty(table.id, id, +1);
          });
        });
        menu.querySelectorAll('[data-minus]').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-minus');
            changeQty(table.id, id, -1);
          });
        });
        menu.querySelectorAll('[data-qty]').forEach(inp => {
          inp.addEventListener('input', () => {
            const id = inp.getAttribute('data-qty');
            setQty(table.id, id, Math.max(0, Number(inp.value || 0)));
          });
        });
      }
    }

    function renderTableSummary(table) {
      const box = $('#table-summary');
      box.innerHTML = '';
      if (Object.keys(table.order).length === 0) {
        box.innerHTML = '<div class="text-gray-500">Sin productos aún.</div>';
        return;
      }
      const ul = document.createElement('ul');
      ul.className = 'space-y-1';
      for (const [itemId, qty] of Object.entries(table.order)) {
        const label = (items.find(i => i.id === itemId)?.label) || itemId;
        const { chargedQty, total } = computeLine(itemId, qty);
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between';
        li.innerHTML = `
          <span>${qty} × ${label} ${itemId==='taco_pastor' && promoEnabled ? `(Pagas ${chargedQty})` : ''}</span>
          <span class="font-semibold">${money(total)}</span>
        `;
        ul.appendChild(li);
      }
      box.appendChild(ul);
    }

    function renderDrawerActions(table) {
      const wrap = $('#drawer-actions');
      wrap.innerHTML = '';
      if (table.charged) {
        wrap.innerHTML = `
          <button id="reopen-table" class="flex-1 bg-amber-500 hover:bg-amber-600 text-white font-semibold py-2 rounded-lg">Reabrir</button>
          <button id="delete-table" class="px-4 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg">Eliminar</button>
        `;
        $('#reopen-table').addEventListener('click', () => reopenTable(table.id));
        $('#delete-table').addEventListener('click', () => deleteTable(table.id));
      } else {
        wrap.innerHTML = `
          <button id="clear-table" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 rounded-lg">Limpiar</button>
          <button id="close-table" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg">Cobrar & Cerrar</button>
          <button id="delete-table" class="px-4 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg">Eliminar</button>
        `;
        $('#clear-table').addEventListener('click', () => clearTable(table.id));
        $('#close-table').addEventListener('click', () => closeTable(table.id));
        $('#delete-table').addEventListener('click', () => deleteTable(table.id));
      }
    }

    // ---------------- Qty updates ----------------
    function changeQty(tableId, itemId, delta) {
      const t = tables.find(x => x.id === tableId);
      if (!t || t.charged) return;
      const cur = t.order[itemId] || 0;
      const next = Math.max(0, cur + delta);
      if (next === 0) delete t.order[itemId]; else t.order[itemId] = next;
      persist();
      if (currentTableId === tableId) openDrawer(tableId);
      renderTables();
    }
    function setQty(tableId, itemId, qty) {
      const t = tables.find(x => x.id === tableId);
      if (!t || t.charged) return;
      if (qty === 0) delete t.order[itemId]; else t.order[itemId] = qty;
      persist();
      if (currentTableId === tableId) openDrawer(tableId);
      renderTables();
    }

    // ---------------- Table actions ----------------
    function addTable() {
      const name = ($('#table-name').value || '').trim();
      const note = ($('#table-note').value || '').trim();
      if (!name) return alert('Escribe un nombre o número de mesa.');
      tables.push({ id: uid(), name, note, order: {}, charged: false, paidAt: null });
      $('#table-name').value = '';
      $('#table-note').value = '';
      persist();
      renderTables();
    }
    function clearTable(tableId) {
      const t = tables.find(x => x.id === tableId);
      if (!t || t.charged) return;
      if (!confirm(`Limpiar orden de ${t.name}?`)) return;
      t.order = {};
      persist();
      if (currentTableId === tableId) openDrawer(tableId);
      renderTables();
    }
    function closeTable(tableId) {
      const t = tables.find(x => x.id === tableId);
      if (!t || t.charged) return;
      const total = computeTableTotal(t);
      if (!confirm(`Cobrar ${t.name} por ${money(total)} y marcar como COBRADA?`)) return;
      t.charged = true;
      t.paidAt = Date.now();
      persist();
      if (currentTableId === tableId) openDrawer(tableId);
      renderTables();
    }
    function reopenTable(tableId) {
      const t = tables.find(x => x.id === tableId);
      if (!t || !t.charged) return;
      if (!confirm(`Reabrir ${t.name} para seguir editando?`)) return;
      t.charged = false;
      t.paidAt = null;
      persist();
      if (currentTableId === tableId) openDrawer(tableId);
      renderTables();
    }
    function deleteTable(tableId) {
      const t = tables.find(x => x.id === tableId);
      if (!t) return;
      if (!confirm(`Eliminar ${t.name}? Esta acción no se puede deshacer.`)) return;
      tables = tables.filter(x => x.id !== tableId);
      persist();
      closeDrawer();
      renderTables();
    }
    function closeAllTables() {
      if (tables.length === 0) return;
      const active = tables.filter(t => !t.charged);
      const total = active.reduce((a, t) => a + computeTableTotal(t), 0);
      if (!active.length) return alert('No hay mesas activas.');
      if (!confirm(`Cobrar & Cerrar TODAS las mesas activas por ${money(total)}?`)) return;
      active.forEach(t => { t.charged = true; t.paidAt = Date.now(); });
      persist();
      if (currentTableId) openDrawer(currentTableId);
      renderTables();
    }

    // ---------------- Wire events ----------------
    function wireEvents() {
      $('#promo-enabled').addEventListener('change', (e) => {
        promoEnabled = !!e.target.checked;
        persist();
        renderPriceEditor();
        renderTables();
        if (currentTableId) openDrawer(currentTableId);
      });

      $('#add-item').addEventListener('click', addNewItem);
      $('#add-table').addEventListener('click', addTable);
      $('#close-all').addEventListener('click', closeAllTables);

      // Close buttons
      $('#drawer-close').addEventListener('click', closeDrawer);
      $('#backdrop').addEventListener('click', closeDrawer);

      $('#save-prices').addEventListener('click', () => {
        items.forEach(it => {
          const el = document.getElementById(`price_${it.id}`);
          if (!el) return;
          const v = Number((el.value || prices[it.id]).toString());
          if (isFinite(v)) prices[it.id] = v;
        });
        persist();
        renderTables();
        if (currentTableId) openDrawer(currentTableId);
      });
    }

    // ---------------- Init ----------------
    function init() {
      // Ensure base items exist (in case of old storage)
      BASE_ITEMS.forEach(b => {
        if (!items.find(x => x.id === b.id)) items.unshift(b);
        if (!(b.id in prices)) prices[b.id] = DEFAULT_PRICES[b.id] || 0;
      });
      persist();

      $('#promo-enabled').checked = !!promoEnabled;
      renderPriceEditor();
      renderTables();
      wireEvents();

      // Optional midnight refresh (manual promo control kept)
      const msToMidnight = (() => {
        const now = new Date();
        const then = new Date(now); then.setHours(24,0,0,0);
        return then - now;
      })();
      setTimeout(() => {
        renderTables();
        if (currentTableId) openDrawer(currentTableId);
      }, msToMidnight + 1000);
    }
    init();
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
        .catch(err => console.warn('SW registration failed', err));
      });
    }
  </script>
</body>
</html>

